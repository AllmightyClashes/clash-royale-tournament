<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Clash Royale Tournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.tailwindcss.com"></script>

<style>
#ui { opacity:0; transform:scale(.96); transition:.6s }
#ui.show { opacity:1; transform:scale(1) }
</style>
</head>

<body class="relative min-h-screen text-white overflow-hidden">

<!-- VIDEO BACKGROUND -->
<video autoplay muted loop playsinline
 class="absolute inset-0 w-full h-full object-cover">
  <source src="logo-animato.mp4" type="video/mp4">
</video>

<div class="absolute inset-0 bg-black/70"></div>

<!-- REGISTRATION UI -->
<div id="ui" class="relative z-10 min-h-screen flex items-center justify-center">
  <div class="bg-white/10 backdrop-blur-xl p-8 rounded-2xl w-full max-w-md">

    <h1 class="text-2xl font-bold text-center mb-2">üèÜ Clash Royale Tournament</h1>
    <p class="text-center mb-4">Iscritti: <span id="count">0</span></p>

    <input id="nickname" placeholder="Nickname"
     class="w-full mb-3 p-3 rounded bg-black/40">

    <input id="playerTag" placeholder="Player Tag"
     class="w-full mb-3 p-3 rounded bg-black/40">

    <input id="discordUser" placeholder="Discord username"
     class="w-full mb-4 p-3 rounded bg-black/40">

    <button onclick="registerPlayer()"
     class="w-full bg-red-600 hover:bg-red-700 p-3 font-bold rounded mb-3">
     READY TO CLASH
    </button>

    <button onclick="startTournament()"
     class="w-full bg-red-600 hover:bg-red-700 p-3 font-bold rounded">
     START TOURNAMENT
    </button>

  </div>
</div>

<!-- BRACKET -->
<div id="bracket" class="hidden relative z-10 p-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-bold">
      Round <span id="roundNum"></span>
    </h2>

    <button onclick="endTournament()"
     class="bg-red-600 px-4 py-2 rounded font-bold">
     END
    </button>
  </div>

  <p class="mb-4">‚è± Tempo round: <span id="timer"></span></p>
  <div id="matches" class="grid md:grid-cols-2 gap-4"></div>
</div>

<!-- FIREBASE + STEP 2B -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  setDoc,
  getDoc,
  query,
  where,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
  authDomain: "allmighty-tournaments.firebaseapp.com",
  projectId: "allmighty-tournaments",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

setTimeout(()=>ui.classList.add("show"),1000);

/* PLAYER COUNT */
async function updateCount(){
  const snap = await getDocs(collection(db,"players"));
  count.textContent = snap.size;
}
updateCount();

/* REGISTER */
window.registerPlayer = async()=>{
  await addDoc(collection(db,"players"),{
    nick:nickname.value,
    tag:playerTag.value,
    discord:discordUser.value,
    createdAt:Date.now(),
    score:0
  });
  nickname.value=playerTag.value=discordUser.value="";
  updateCount();
};

/* START TOURNAMENT */
window.startTournament = async()=>{
  if(prompt("Password")!=="robifede") return;

  const snap = await getDocs(collection(db,"players"));
  let players=[];
  snap.forEach(d=>players.push(d.data().discord));

  players.sort(()=>Math.random()-.5);

  await setDoc(doc(db,"tournament","state"),{
    started:true,
    round:1,
    roundStart:Date.now()
  });

  if(players.length%2){
    await addDoc(collection(db,"matches"),{
      round:1,p1:players.pop(),p2:null,bye:true,winner:null
    });
  }

  for(let i=0;i<players.length;i+=2){
    await addDoc(collection(db,"matches"),{
      round:1,p1:players[i],p2:players[i+1],bye:false,winner:null
    });
  }
};

/* END */
window.endTournament = async()=>{
  if(prompt("Password")!=="robifede") return;
  await setDoc(doc(db,"tournament","state"),{started:false});
  location.reload();
};

/* STEP 2B ‚Äî LIVE BRACKET */
onSnapshot(doc(db,"tournament","state"), async snap=>{
  const state = snap.data();
  if(!state || !state.started) return;

  ui.classList.add("hidden");
  bracket.classList.remove("hidden");
  roundNum.textContent = state.round;

  onSnapshot(
    query(collection(db,"matches"), where("round","==",state.round)),
    snap=>{
      matches.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="bg-white/10 p-3 rounded text-center";

        if(m.bye){
          div.textContent = `${m.p1} (BYE)`;
        } else {
          div.innerHTML = `<b>${m.p1}</b><br>vs<br><b>${m.p2}</b>`;
        }
        matches.appendChild(div);
      });
    }
  );

  startTimer(state.roundStart);
});

/* TIMER */
function startTimer(start){
  setInterval(()=>{
    let diff = 900000 - (Date.now()-start);
    if(diff<0) diff=0;
    timer.textContent =
      Math.floor(diff/60000)+"m "+
      Math.floor(diff%60000/1000)+"s";
  },1000);
}
</script>

</body>
</html>
