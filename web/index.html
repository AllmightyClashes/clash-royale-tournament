<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Clash Royale Tournament – 1024</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    margin: 0;
    overflow-x: hidden;
  }
  video.bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    z-index: -1;
  }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
  authDomain: "allmighty-tournaments.firebaseapp.com",
  projectId: "allmighty-tournaments",
  storageBucket: "allmighty-tournaments.appspot.com",
  messagingSenderId: "876830337732",
  appId: "1:876830337732:web:12509e3197a65e6350b791"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let players = [];
let bracket = [];
let startTime = null;

/* ---------- LOAD STATUS ---------- */
async function loadStatus() {
  const snap = await getDoc(doc(db, "tournament", "status"));
  if (snap.exists() && snap.data().started) {
    startTime = snap.data().startTime;
    showBracket();
    startTimer();
  }
}

/* ---------- REGISTER PLAYER ---------- */
window.registerPlayer = async () => {
  const nick = nickname.value.trim();
  const tag = playerTag.value.trim();
  const discord = discordUser.value.trim();
  if (!nick || !tag || !discord) return;

  await addDoc(collection(db, "players"), { nick, tag, discord });
  alert("Iscritto!");
};

/* ---------- START TOURNAMENT ---------- */
window.startTournament = async () => {
  const pwd = prompt("Password");
  if (pwd !== "robifede") return alert("Password errata");

  const statusRef = doc(db, "tournament", "status");
  const snap = await getDoc(statusRef);
  if (snap.exists() && snap.data().started) {
    return alert("Torneo già iniziato");
  }

  const pSnap = await getDocs(collection(db, "players"));
  players = [];
  pSnap.forEach(d => players.push(d.data()));

  if (players.length < 2) return alert("Giocatori insufficienti");

  players.sort(() => Math.random() - 0.5);

  bracket = [];
  for (let i = 0; i < players.length; i += 2) {
    bracket.push({
      p1: players[i]?.nick || "BYE",
      p2: players[i+1]?.nick || "BYE"
    });
  }

  startTime = Date.now();
  await setDoc(statusRef, { started: true, startTime });

  showBracket();
  startTimer();
};

/* ---------- END TOURNAMENT ---------- */
window.endTournament = async () => {
  const pwd = prompt("Password");
  if (pwd !== "robifede") return alert("Password errata");

  await setDoc(doc(db, "tournament", "status"), { started: false });
  location.reload();
};

/* ---------- UI ---------- */
function showBracket() {
  registration.classList.add("hidden");
  bracketPage.classList.remove("hidden");

  bracketList.innerHTML = "";
  bracket.forEach(m => {
    const li = document.createElement("li");
    li.textContent = `${m.p1} vs ${m.p2}`;
    bracketList.appendChild(li);
  });
}

function startTimer() {
  setInterval(() => {
    const diff = Math.floor((Date.now() - startTime) / 1000);
    timer.textContent = `⏱ ${diff}s`;
  }, 1000);
}

window.onload = loadStatus;
</script>
</head>

<body>

<video class="bg" autoplay muted loop>
  <source src="logo-animato.mp4" type="video/mp4">
</video>

<!-- REGISTRATION -->
<div id="registration" class="min-h-screen flex items-center justify-center">
  <div class="bg-black/50 p-6 rounded-xl w-80">
    <h2 class="text-xl font-bold mb-3">Iscrizione</h2>
    <input id="nickname" class="w-full mb-2 p-2 text-black" placeholder="Nickname">
    <input id="playerTag" class="w-full mb-2 p-2 text-black" placeholder="Player Tag">
    <input id="discordUser" class="w-full mb-2 p-2 text-black" placeholder="Discord">
    <button onclick="registerPlayer()" class="w-full bg-yellow-500 p-2">Iscriviti</button>

    <button onclick="startTournament()" 
      class="w-full mt-4 bg-green-600 p-2 font-bold">
      START TOURNAMENT
    </button>
  </div>
</div>

<!-- BRACKET -->
<div id="bracketPage" class="hidden p-6">
  <div class="flex justify-between">
    <h2 id="timer" class="text-xl font-bold"></h2>
    <button onclick="endTournament()" class="bg-red-600 p-2">
      END
    </button>
  </div>
  <ul id="bracketList" class="mt-6 space-y-2"></ul>
</div>

</body>
</html>
