<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Allmighty Clashes Tournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
.fade {
  opacity:0;
  transform:scale(.96);
  transition:.6s ease;
}
.fade.show {
  opacity:1;
  transform:scale(1);
}
</style>
</head>

<body class="relative min-h-screen text-white overflow-hidden">

<!-- VIDEO -->
<video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover">
  <source src="logo-animato.mp4" type="video/mp4">
</video>
<div class="absolute inset-0 bg-black/70"></div>

<!-- INTRO -->
<div id="introBox" class="absolute inset-0 z-10 flex items-center justify-center fade show">
  <h1 class="text-4xl font-bold text-center">
    ‚öî Allmighty Clashes are coming ‚öî
  </h1>
</div>

<!-- UI -->
<div id="ui" class="relative z-10 p-6 max-w-4xl mx-auto hidden fade">

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-4">
    <h2 id="headerTitle" class="text-xl font-bold"></h2>

    <button onclick="showRanking()" class="bg-white/20 px-4 py-2 rounded">
      RANKING
    </button>
  </div>

  <!-- TIMER -->
  <p id="timerBox" class="text-center text-2xl font-bold mb-6 hidden">
    ‚è± <span id="timer"></span>
  </p>

  <!-- MATCHES -->
  <div id="matches" class="grid md:grid-cols-2 gap-4"></div>

  <!-- CLASSIFICA LIVE -->
  <div id="rankingView" class="hidden mt-6"></div>

  <!-- CLASSIFICA FINALE -->
  <div id="finalRanking" class="hidden mt-10"></div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, collection, getDocs, onSnapshot,
  query, where, writeBatch
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
  authDomain: "allmighty-tournaments.firebaseapp.com",
  projectId: "allmighty-tournaments"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- UI HELPERS ----------
function showIntro(){
  introBox.classList.remove("hidden");
  introBox.classList.add("show");
  ui.classList.add("hidden");
}

function showUI(){
  introBox.classList.add("hidden");
  ui.classList.remove("hidden");
  ui.classList.add("show");
}

function resetViews(){
  matches.innerHTML = "";
  rankingView.classList.add("hidden");
  finalRanking.classList.add("hidden");
}

// ---------- STATO TORNEO ----------
onSnapshot(doc(db,"tournament","state"), async snap=>{
  if(!snap.exists()) return;
  const d = snap.data();

  resetViews();

  // üèÜ TORNEO TERMINATO
  if(d.ended){
    showUI();
    headerTitle.textContent = "üèÜ Tournament Ended";
    timerBox.classList.add("hidden");

    await showFinalRanking();
    return;
  }

  // ‚öî TORNEO ATTIVO
  if(d.started){
    showUI();
    headerTitle.textContent = `Round ${d.round}`;
    timerBox.classList.remove("hidden");

    listenMatches(d.round);
    startTimer(d.roundStart, d.roundDuration);
    return;
  }

  // ‚è≥ ATTESA
  showIntro();
});

// ---------- MATCHES ----------
function listenMatches(round){
  onSnapshot(
    query(collection(db,"matches"), where("round","==",round)),
    snap=>{
      matches.innerHTML="";
      snap.forEach(d=>{
        const m=d.data();
        const div=document.createElement("div");
        div.className="bg-white/10 p-3 rounded text-center";
        div.innerHTML = m.p2
          ? `<b>${m.p1}</b><br>vs<br><b>${m.p2}</b>`
          : `${m.p1} (BYE)`;
        matches.appendChild(div);
      });
    }
  );
}

// ---------- TIMER ----------
let timerInt;
function startTimer(start,duration){
  clearInterval(timerInt);
  timerInt=setInterval(()=>{
    let d=duration-(Date.now()-start);
    if(d<0)d=0;
    timer.textContent =
      Math.floor(d/60000)+"m "+Math.floor(d%60000/1000)+"s";
  },1000);
}

// ---------- CLASSIFICA LIVE ----------
function showRanking(){
  rankingView.innerHTML="";
  rankingView.classList.remove("hidden");
  finalRanking.classList.add("hidden");

  getDocs(collection(db,"players")).then(snap=>{
    let players=[];
    snap.forEach(doc=>{
      const p=doc.data();
      if(!p.dropped) players.push(p);
    });

    players.sort((a,b)=> (b.score??0)-(a.score??0));

    players.forEach((p,i)=>{
      const div=document.createElement("div");
      div.className="bg-white/10 p-2 rounded mb-1 flex justify-between";
      div.innerHTML=`<span>${i+1}. ${p.nick}</span><span>Score: ${p.score??0}</span>`;
      rankingView.appendChild(div);
    });
  });
}

// ---------- CLASSIFICA FINALE ----------
async function showFinalRanking(){
  finalRanking.innerHTML="";
  finalRanking.classList.remove("hidden");
  finalRanking.classList.add("show");

  const snap = await getDocs(collection(db,"players"));
  let players=[];
  snap.forEach(doc=>players.push(doc.data()));
  players.sort((a,b)=> (b.score??0)-(a.score??0));

  finalRanking.innerHTML="<h2 class='text-xl font-bold mb-4'>Classifica finale</h2>";

  players.forEach((p,i)=>{
    const div=document.createElement("div");
    div.className="bg-white/10 p-2 rounded mb-1 flex justify-between";
    div.innerHTML=`<span>${i+1}. ${p.nick}</span><span>Score: ${p.score??0}</span>`;
    finalRanking.appendChild(div);
  });
}
</script>

</body>
</html>
