<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Clash Royale Tournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
#ui{opacity:0;transform:scale(.96);transition:.6s}
#ui.show{opacity:1;transform:scale(1)}
</style>
</head>

<body class="relative min-h-screen text-white overflow-hidden">

<video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover">
  <source src="logo-animato.mp4" type="video/mp4">
</video>
<div class="absolute inset-0 bg-black/70"></div>

<!-- UI -->
<div id="ui" class="relative z-10 p-6 max-w-4xl mx-auto hidden">

<!-- HEADER -->
<div id="header" class="flex justify-between items-center mb-4 hidden">
  <h2 class="text-xl font-bold">
    Round <span id="roundNum"></span>
  </h2>

  <div class="flex gap-2">
    <button onclick="showPairings()" class="bg-white/20 px-4 py-2 rounded">PAIRINGS</button>
    <button onclick="showRanking()" class="bg-white/20 px-4 py-2 rounded">RANKING</button>
  </div>
</div>

<!-- TIMER -->
<p id="timerBox" class="text-center text-2xl font-bold mb-6 hidden">
 ‚è± <span id="timer"></span>
</p>

<div id="matches" class="grid md:grid-cols-2 gap-4 hidden"></div>
<div id="rankingView" class="hidden mt-6"></div>

<!-- FINAL RANKING -->
<div id="finalRanking" class="hidden mt-10"></div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
 getFirestore, doc, collection, getDocs,
 query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
 authDomain:"allmighty-tournaments.firebaseapp.com",
 projectId:"allmighty-tournaments"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

setTimeout(()=>ui.classList.add("show"),500);

/* TOURNAMENT STATE */
onSnapshot(doc(db,"tournament","state"),snap=>{
 if(!snap.exists()) return;

 const data = snap.data();
 ui.classList.remove("hidden");

 // TORNEO FINITO
 if(!data.started && data.ended){
  showFinalRanking();
  return;
 }

 // TORNEO ATTIVO
 if(data.started){
  header.classList.remove("hidden");
  timerBox.classList.remove("hidden");
  matches.classList.remove("hidden");
  finalRanking.classList.add("hidden");

  roundNum.textContent = data.round;
  listenMatches(data.round);
  startTimer(data.roundStart, data.roundDuration);
 }
});

/* MATCHES */
function listenMatches(round){
 onSnapshot(
  query(collection(db,"matches"), where("round","==",round)),
  s=>{
   matches.innerHTML="";
   s.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="bg-white/10 p-3 rounded text-center";
    div.innerHTML = m.p2
      ? `<b>${m.p1}</b><br>vs<br><b>${m.p2}</b>`
      : `${m.p1} (BYE)`;
    matches.appendChild(div);
   });
  }
 );
}

/* FINAL RANKING */
async function showFinalRanking(){
 header.classList.add("hidden");
 timerBox.classList.add("hidden");
 matches.classList.add("hidden");
 rankingView.classList.add("hidden");
 finalRanking.classList.remove("hidden");

 const snap = await getDocs(collection(db,"players"));
 let players=[];
 snap.forEach(d=>players.push(d.data()));

 players.sort((a,b)=>b.score-a.score||b.ranking-a.ranking);

 finalRanking.innerHTML = `
  <h2 class="text-3xl font-bold text-center mb-6">üèÜ Classifica Finale</h2>
 `;

 players.forEach((p,i)=>{
  finalRanking.innerHTML+=`
   <div class="flex justify-between bg-white/10 p-4 rounded mb-2 text-lg">
    <span>#${i+1} ${p.nick}</span>
    <span>${p.score} pts</span>
   </div>`;
 });
}

/* VIEW SWITCH */
window.showRanking = async()=>{
 matches.classList.add("hidden");
 rankingView.classList.remove("hidden");

 const snap = await getDocs(collection(db,"players"));
 let players=[];
 snap.forEach(d=>players.push(d.data()));
 players.sort((a,b)=>b.score-a.score||b.ranking-a.ranking);

 rankingView.innerHTML =
  `<h3 class="text-xl font-bold mb-4 text-center">üèÖ Ranking</h3>`;

 players.forEach((p,i)=>{
  rankingView.innerHTML+=`
   <div class="flex justify-between bg-white/10 p-3 rounded mb-2">
    <span>#${i+1} ${p.nick}</span>
    <span>${p.score} pts</span>
   </div>`;
 });
};

window.showPairings=()=>{
 matches.classList.remove("hidden");
 rankingView.classList.add("hidden");
};

/* TIMER */
let timerInt;
function startTimer(start,duration){
 clearInterval(timerInt);
 timerInt=setInterval(()=>{
  let d=duration-(Date.now()-start);
  if(d<0)d=0;
  timer.textContent=
   Math.floor(d/60000)+"m "+
   Math.floor(d%60000/1000)+"s";
 },1000);
}
</script>

</body>
</html>
