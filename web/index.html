<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Clash Royale Tournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
#ui,#registerBox{
  opacity:0;
  transform:scale(.96);
  transition:.6s;
}
#ui.show,#registerBox.show{
  opacity:1;
  transform:scale(1);
}
</style>
</head>

<body class="relative min-h-screen text-white overflow-hidden">

<!-- VIDEO -->
<video autoplay muted loop playsinline
 class="absolute inset-0 w-full h-full object-cover">
  <source src="logo-animato.mp4" type="video/mp4">
</video>
<div class="absolute inset-0 bg-black/70"></div>

<!-- REGISTRATION (CENTRATA) -->
<div id="registerBox"
 class="absolute inset-0 z-10 flex items-center justify-center">

  <div class="bg-white/10 backdrop-blur-xl p-8 rounded-2xl w-full max-w-md">

    <h1 class="text-2xl font-bold text-center mb-1">üèÜ Tournament Registration</h1>
    <p class="text-center mb-2">enter your details</p>

    <p class="text-center mb-4 text-sm opacity-90">
      üë• registered players: <span id="playerCount">0</span>
    </p>

    <input id="nickname" placeholder="Nickname"
     class="w-full mb-3 p-3 rounded bg-black/40">

    <input id="discordUser" placeholder="Discord username"
     class="w-full mb-4 p-3 rounded bg-black/40">

    <button onclick="registerPlayer()"
     class="w-full bg-red-600 p-3 font-bold rounded mb-3">
     ‚öî READY TO CLASH ‚öî
    </button>

  </div>
</div>

<!-- UI TORNEO -->
<div id="ui"
 class="relative z-10 p-6 max-w-4xl mx-auto hidden">

  <div id="header"
   class="flex justify-between items-center mb-4 hidden">

    <h2 class="text-xl font-bold">
      Round <span id="roundNum"></span>
    </h2>

    <div class="flex gap-2">
      <button onclick="showPairings()" class="bg-white/20 px-4 py-2 rounded">
        PAIRINGS
      </button>
      <button onclick="showRanking()" class="bg-white/20 px-4 py-2 rounded">
        RANKING
      </button>
    </div>
  </div>

  <p id="timerBox"
   class="text-center text-2xl font-bold mb-6 hidden">
    ‚è± <span id="timer"></span>
  </p>

  <div id="matches" class="grid md:grid-cols-2 gap-4 hidden"></div>
  <div id="rankingView" class="hidden mt-6"></div>
  <div id="finalRanking" class="hidden mt-10"></div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
 getFirestore, doc, collection, addDoc, getDocs,
 setDoc, query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
 authDomain:"allmighty-tournaments.firebaseapp.com",
 projectId:"allmighty-tournaments"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ANIMAZIONE SOLO REGISTRAZIONE */
setTimeout(()=> registerBox.classList.add("show"), 300);

/* LIVE PLAYER COUNT */
onSnapshot(collection(db,"players"), snap=>{
 playerCount.textContent = snap.size;
});

/* REGISTER */
window.registerPlayer = async()=>{
 if(!nickname.value || !discordUser.value){
  alert("Compila tutti i campi");
  return;
 }

 const snap = await getDocs(collection(db,"players"));
 let exists=false;
 snap.forEach(d=>{
  if(d.data().discord.toLowerCase() === discordUser.value.toLowerCase())
   exists=true;
 });

 if(exists){
  alert("‚ö†Ô∏è Sei gi√† registrato");
  return;
 }

 await addDoc(collection(db,"players"),{
  nick:nickname.value,
  discord:discordUser.value,
  score:0,
  ranking:1000,
  dropped:false,
  createdAt:Date.now()
 });

 nickname.value = discordUser.value = "";
 alert("‚úÖ Registrazione completata!");
};

/* TOURNAMENT STATE */
onSnapshot(doc(db,"tournament","state"), snap=>{
 if(!snap.exists()) return;
 const d = snap.data();

 if(d.started){
  registerBox.classList.add("hidden");
  ui.classList.remove("hidden");
  ui.classList.add("show");

  header.classList.remove("hidden");
  timerBox.classList.remove("hidden");
  matches.classList.remove("hidden");

  roundNum.textContent = d.round;
  listenMatches(d.round);
  startTimer(d.roundStart, d.roundDuration);
 }
});

/* MATCHES */
function listenMatches(round){
 onSnapshot(
  query(collection(db,"matches"), where("round","==",round)),
  s=>{
   matches.innerHTML="";
   s.forEach(d=>{
    const m=d.data();
    const div=document.createElement("div");
    div.className="bg-white/10 p-3 rounded text-center";
    div.innerHTML = m.p2
      ? `<b>${m.p1}</b><br>vs<br><b>${m.p2}</b>`
      : `${m.p1} (BYE)`;
    matches.appendChild(div);
   });
  }
 );
}

/* TIMER */
let timerInt;
function startTimer(start,duration){
 clearInterval(timerInt);
 timerInt=setInterval(()=>{
  let d=duration-(Date.now()-start);
  if(d<0)d=0;
  timer.textContent =
   Math.floor(d/60000)+"m "+
   Math.floor(d%60000/1000)+"s";
 },1000);
}
</script>

</body>
</html>



