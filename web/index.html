<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Clash Royale Tournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
#ui{opacity:0;transform:scale(.96);transition:.6s}
#ui.show{opacity:1;transform:scale(1)}
</style>
</head>

<body class="relative min-h-screen text-white overflow-hidden">

<!-- VIDEO BACKGROUND -->
<video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover">
  <source src="logo-animato.mp4" type="video/mp4">
</video>
<div class="absolute inset-0 bg-black/70"></div>

<!-- REGISTRATION -->
<div id="ui" class="relative z-10 min-h-screen flex items-center justify-center">
<div class="bg-white/10 backdrop-blur-xl p-8 rounded-2xl w-full max-w-md">

<h1 class="text-2xl font-bold text-center mb-2">üèÜ Clash Royale Tournament</h1>
<p class="text-center mb-4">Iscritti: <span id="count">0</span></p>

<input id="nickname" placeholder="Nickname" class="w-full mb-3 p-3 rounded bg-black/40">
<input id="playerTag" placeholder="Player Tag" class="w-full mb-3 p-3 rounded bg-black/40">
<input id="discordUser" placeholder="Discord username" class="w-full mb-4 p-3 rounded bg-black/40">

<button onclick="registerPlayer()" class="w-full bg-red-600 p-3 font-bold rounded mb-3">
READY TO CLASH
</button>

<button onclick="startTournament()" class="w-full bg-red-600 p-3 font-bold rounded">
START TOURNAMENT
</button>

</div>
</div>

<!-- BRACKET -->
<div id="bracket" class="hidden relative z-10 p-6">

<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Round <span id="roundNum"></span></h2>

<div class="flex gap-2">
<button onclick="showPairings()" class="bg-white/20 px-4 py-2 rounded">PAIRINGS</button>
<button onclick="showRanking()" class="bg-white/20 px-4 py-2 rounded">RANKING</button>
</div>

<button onclick="endTournament()" class="bg-red-600 px-4 py-2 rounded font-bold">END</button>
</div>

<p class="mb-4">‚è± Tempo round: <span id="timer"></span></p>

<div id="matches" class="grid md:grid-cols-2 gap-4"></div>
<div id="rankingView" class="hidden mt-6"></div>

<div class="mt-6 text-center">
<button id="nextRoundBtn"
 class="hidden bg-green-600 px-6 py-3 rounded font-bold">
NEXT ROUND
</button>
</div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
 getFirestore, collection, addDoc, getDocs,
 doc, setDoc, getDoc, query, where, onSnapshot
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
 apiKey:"AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
 authDomain:"allmighty-tournaments.firebaseapp.com",
 projectId:"allmighty-tournaments"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
setTimeout(()=>ui.classList.add("show"),1000);

/* COUNT */
async function updateCount(){
 const snap = await getDocs(collection(db,"players"));
 count.textContent = snap.size;
}
updateCount();

/* REGISTER */
window.registerPlayer = async()=>{
 await addDoc(collection(db,"players"),{
  nick:nickname.value,
  tag:playerTag.value,
  discord:discordUser.value,
  score:0,
  ranking:1000,
  createdAt:Date.now()
 });
 nickname.value=playerTag.value=discordUser.value="";
 updateCount();
};

/* START */
window.startTournament = async()=>{
 if(prompt("Password")!=="robifede") return;
 await setDoc(doc(db,"tournament","state"),{
  started:true,
  round:1,
  roundStart:Date.now()
 });
};

/* END */
window.endTournament = async()=>{
 if(prompt("Password")!=="robifede") return;
 await setDoc(doc(db,"tournament","state"),{started:false});
 location.reload();
};

/* LIVE VIEW */
onSnapshot(doc(db,"tournament","state"),snap=>{
 if(!snap.exists() || !snap.data().started) return;

 ui.classList.add("hidden");
 bracket.classList.remove("hidden");
 roundNum.textContent = snap.data().round;

 onSnapshot(
  query(collection(db,"matches"),where("round","==",snap.data().round)),
  s=>{
   matches.innerHTML="";
   let allDone=true;

   s.forEach(d=>{
    const m=d.data();
    if(!m.winner) allDone=false;

    const div=document.createElement("div");
    div.className="bg-white/10 p-3 rounded text-center";
    div.innerHTML = m.p2
      ? `<b>${m.p1}</b><br>vs<br><b>${m.p2}</b>`
      : `${m.p1} (BYE)`;
    matches.appendChild(div);
   });

   nextRoundBtn.classList.toggle("hidden",!allDone);
  }
 );

 startTimer(snap.data().roundStart);
});

/* VIEW SWITCH */
window.showPairings=()=>{matches.classList.remove("hidden");rankingView.classList.add("hidden")};

window.showRanking=async()=>{
 matches.classList.add("hidden"); rankingView.classList.remove("hidden");
 const snap=await getDocs(collection(db,"players"));
 let p=[]; snap.forEach(d=>p.push(d.data()));
 p.sort((a,b)=>b.score-a.score||b.ranking-a.ranking);

 rankingView.innerHTML=`<h3 class="text-xl font-bold mb-4 text-center">üèÖ Ranking</h3>`;
 p.forEach((x,i)=>{
  rankingView.innerHTML+=`
  <div class="flex justify-between bg-white/10 p-3 rounded mb-2">
   <span>#${i+1} ${x.nick}</span>
   <span>Score: ${x.score}</span>
  </div>`;
 });
};

/* TIMER */
function startTimer(start){
 setInterval(()=>{
  let d=900000-(Date.now()-start);
  if(d<0)d=0;
  timer.textContent=Math.floor(d/60000)+"m "+Math.floor(d%60000/1000)+"s";
 },1000);
}
</script>
</body>
</html>
