<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Allmighty Clashes Tournament</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.tailwindcss.com"></script>

<style>
.fade {
  opacity: 0;
  transform: scale(.96);
  transition: .6s;
}
.fade.show {
  opacity: 1;
  transform: scale(1);
}
</style>
</head>

<body class="relative min-h-screen text-white overflow-hidden">

<!-- VIDEO BACKGROUND -->
<video autoplay muted loop playsinline class="absolute inset-0 w-full h-full object-cover">
  <source src="logo-animato.mp4" type="video/mp4">
</video>
<div class="absolute inset-0 bg-black/70"></div>

<!-- INTRO -->
<div id="intro" class="absolute inset-0 z-10 flex items-center justify-center fade show">
  <h1 class="text-4xl font-bold text-center">⚔ Allmighty Clashes are coming ⚔</h1>
</div>

<!-- UI -->
<div id="ui" class="relative z-10 p-6 max-w-4xl mx-auto hidden fade">

  <div class="flex justify-between items-center mb-4">
    <h2 id="title" class="text-xl font-bold"></h2>
    <button onclick="showRanking()" class="bg-white/20 px-4 py-2 rounded">
      RANKING
    </button>
  </div>

  <p id="timerBox" class="text-center text-2xl font-bold mb-6"></p>

  <div id="matches" class="grid md:grid-cols-2 gap-4"></div>
  <div id="ranking" class="hidden mt-6"></div>

</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, doc, collection, getDocs,
  onSnapshot, query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyBUjtbuQfc2drjqivgoLFEyQ9k4Un4f6fQ",
  authDomain:"allmighty-tournaments.firebaseapp.com",
  projectId:"allmighty-tournaments"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const intro = document.getElementById("intro");
const ui = document.getElementById("ui");
const title = document.getElementById("title");
const timerBox = document.getElementById("timerBox");
const matches = document.getElementById("matches");
const ranking = document.getElementById("ranking");

let timerInt = null;

/* ================= TOURNAMENT STATE ================= */
onSnapshot(doc(db,"tournament","state"), async snap => {
  if (!snap.exists()) {
    resetUI();
    return;
  }

  const d = snap.data();

  // PRIORITÀ: torneo concluso
  if (d.ended === true) {
    showUI();
    title.textContent = "Tournament ended";
    stopTimer();
    matches.innerHTML = "";
    await showFinalRanking();
    return; // esci subito
  }

  // Torneo in corso
  if (d.started === true && d.round != null) {
    showUI();
    title.textContent = `Round ${d.round}`;
    ranking.classList.add("hidden");
    matches.innerHTML = "";
    listenMatches(d.round);
    startTimer(d.roundStart, d.roundDuration);
    return;
  }

  // Torneo non iniziato
  resetUI();
});

/* ================= MATCHES ================= */
function listenMatches(round){
  if (!round) return;

  const q = query(collection(db,"matches"), where("round","==",round));
  onSnapshot(q, snap => {
    matches.innerHTML = "";
    snap.forEach(doc => {
      const m = doc.data();
      const p2 = m.p2 ?? "BYE";
      const div = document.createElement("div");
      div.className = "bg-white/10 p-3 rounded text-center";
      div.innerHTML = `<b>${m.p1}</b><br>vs<br><b>${p2}</b>`;
      matches.appendChild(div);
    });
  });
}

/* ================= TIMER ================= */
function startTimer(start, duration){
  stopTimer();
  if (!start || !duration) {
    timerBox.textContent = "⏱ In progress";
    return;
  }

  timerInt = setInterval(() => {
    let diff = duration - (Date.now() - start);
    if (diff < 0) diff = 0;
    const minutes = Math.floor(diff / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    timerBox.textContent = `⏱ ${minutes}m ${seconds}s`;
  }, 1000);
}

function stopTimer(){
  clearInterval(timerInt);
  timerBox.textContent = "⏱ Tournament finished";
}

/* ================= RANKING ================= */
async function showFinalRanking(){
  ranking.innerHTML = "<h3 class='text-lg font-bold mb-2'>Final ranking</h3>";
  ranking.classList.remove("hidden");

  const snap = await getDocs(
    query(
      collection(db,"tournament_logs"),
      orderBy("endedAt","desc"),
      limit(1)
    )
  );

  if (snap.empty) {
    ranking.innerHTML += "<p>Nessun dato disponibile</p>";
    return;
  }

  const log = snap.docs[0].data();

  log.standings.forEach((p,i) => {
    const div = document.createElement("div");
    div.className="bg-white/10 p-2 rounded mb-1 flex justify-between";
    div.innerHTML = `<span>${i+1}. ${p.nick}</span><span>Score: ${p.score}</span>`;
    ranking.appendChild(div);
  });
}

window.showRanking = showFinalRanking;

/* ================= UI HELPERS ================= */
function showUI(){
  intro.classList.add("hidden");
  ui.classList.remove("hidden");
  ui.classList.add("show");
}

function resetUI(){
  stopTimer();
  ui.classList.add("hidden");
  intro.classList.remove("hidden");
  matches.innerHTML = "";
  ranking.classList.add("hidden");
}
</script>

</body>
</html>
